name: Review Gate

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
  issue_comment:
    types: [created, edited]

jobs:
  check-review:
    runs-on: ubuntu-latest
    # Only run on PR comments or PR events
    if: github.event_name == 'pull_request' || github.event.issue.pull_request

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Get PR Number
        id: pr
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          else
            # For issue_comment events on PRs
            PR_NUMBER=$(echo "${{ github.event.issue.pull_request.url }}" | grep -oE '[0-9]+$')
            echo "PR_NUMBER=${PR_NUMBER}" >> $GITHUB_ENV
          fi

      - name: Check Review Requirements
        env:
          GH_TOKEN: ${{ github.token }}
          CI: true
        run: |
          # Get the base and head for comparison
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}

          # Check out PR branch
          git checkout ${{ github.event.pull_request.head.ref }}

          # Run validation
          python3 scripts/validate_review.py

      - name: Update PR Status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const { PR_NUMBER } = process.env;
            const success = ${{ job.status == 'success' }};

            const status = success ? '✅' : '❌';
            const message = success
              ? 'Review requirements satisfied'
              : 'Review requirements not met - check workflow logs';

            // Add or update status comment
            const marker = '<!-- review-gate-status -->';
            const body = `${marker}\n### Review Gate Status: ${status}\n\n${message}`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: PR_NUMBER
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes(marker)
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: PR_NUMBER,
                body
              });
            }

name: Review Gate

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
  issue_comment:
    types: [created, edited]

jobs:
  check-review:
    runs-on: ubuntu-latest
    # Only run on PR comments or PR events
    if: github.event_name == 'pull_request' || github.event.issue.pull_request

    # Required for PR commenting
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Get PR Number
        id: pr
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            # For issue_comment events on PRs
            PR_NUMBER=$(echo "${{ github.event.issue.pull_request.url }}" | grep -oE '[0-9]+$')
            echo "number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          fi

      - name: Check Review Requirements
        id: review_check
        env:
          GH_TOKEN: ${{ github.token }}
          CI: true
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        run: |
          # Get PR details for both event types
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="${{ github.event.pull_request.base.ref }}"
            HEAD_REF="${{ github.event.pull_request.head.ref }}"
          else
            # For issue_comment events, fetch PR details via API
            PR_DATA=$(gh pr view ${{ steps.pr.outputs.number }} --json baseRefName,headRefName)
            BASE_REF=$(echo "$PR_DATA" | jq -r '.baseRefName')
            HEAD_REF=$(echo "$PR_DATA" | jq -r '.headRefName')
          fi

          echo "Base: $BASE_REF, Head: $HEAD_REF"
          export GITHUB_BASE_REF="origin/$BASE_REF"

          # Fetch both branches
          git fetch origin "$BASE_REF"
          git fetch origin "$HEAD_REF"

          # Check out PR branch
          git checkout "$HEAD_REF"

          # Run validation and capture output
          set +e  # Don't exit on error
          OUTPUT=$(python3 scripts/validate_review.py 2>&1)
          EXIT_CODE=$?
          set -e

          # Save output for next step
          echo "$OUTPUT"
          echo "$OUTPUT" > /tmp/review_output.txt

          # Set output for next step
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

          exit $EXIT_CODE

      - name: Update PR Status
        if: always()
        uses: actions/github-script@v7
        env:
          REVIEW_EXIT_CODE: ${{ steps.review_check.outputs.exit_code }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        with:
          script: |
            const fs = require('fs');
            const prNumber = process.env.PR_NUMBER;
            const exitCode = process.env.REVIEW_EXIT_CODE;
            const success = exitCode === '0';

            // Read validation output if available
            let validationOutput = '';
            try {
              validationOutput = fs.readFileSync('/tmp/review_output.txt', 'utf8');
            } catch (e) {
              validationOutput = 'Unable to read validation output';
            }

            // Parse key information from output
            const tierMatch = validationOutput.match(/üìã Review Tier: (\S+)/);
            const reasonMatch = validationOutput.match(/Reason: (.+)/);
            const tier = tierMatch ? tierMatch[1] : 'UNKNOWN';

            // Build status message
            const status = success ? '‚úÖ' : '‚ùå';
            let message = '';

            if (success) {
              message = '**Review requirements satisfied**\n\n';
              message += `**Tier**: ${tier}\n`;
              message += validationOutput.includes('TIER_0_EXEMPT')
                ? '‚úì Exempt from review (docs/tests only)\n'
                : '‚úì Required approvals found\n';
            } else {
              message = '**Review requirements not met**\n\n';
              message += `**Tier**: ${tier}\n`;

              if (reasonMatch) {
                message += `**Reason**: ${reasonMatch[1]}\n\n`;
              }

              // Extract required reviews from output
              if (tier === 'TIER_1_SELF') {
                message += '**Required**: Add a comment with:\n';
                message += '```\nIL SELF-REVIEWED: [your rationale for this change]\n```\n';
              } else if (tier === 'TIER_2_CRS') {
                message += '**Required**: Code Review Specialist approval with:\n';
                message += '```\nCRS APPROVED: [assessment of change]\n```\n';
              } else if (tier === 'TIER_3_FULL') {
                message += '**Required**: Both approvals with:\n';
                message += '```\nCRS APPROVED: [assessment]\nCE APPROVED: [critical assessment]\n```\n';
              }

              message += '\n<details><summary>üìã Full Validation Output</summary>\n\n';
              message += '```\n' + validationOutput + '\n```\n';
              message += '</details>\n';
            }

            // Add or update status comment
            const marker = '<!-- review-gate-status -->';
            const body = `${marker}\n## Review Gate Status: ${status}\n\n${message}`;

            try {
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber
              });

              const botComment = comments.find(c =>
                c.user.type === 'Bot' && c.body.includes(marker)
              );

              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body
                });
                console.log('Updated existing review status comment');
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body
                });
                console.log('Created new review status comment');
              }
            } catch (error) {
              console.error('Failed to update PR comment:', error);
              core.setFailed(`Failed to update PR status: ${error.message}`);
            }
